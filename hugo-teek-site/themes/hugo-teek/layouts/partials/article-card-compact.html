<article class="article-card-compact {{ if .Params.sticky }}is-sticky{{ end }} {{ if .Params.featured }}is-featured{{ end }}"
         {{ with .Params.categories }}data-categories="{{ delimit . "," }}"{{ end }}
         {{ with .Params.tags }}data-tags="{{ delimit . "," }}"{{ end }}>
  <a href="{{ .RelPermalink }}" class="card-link">
    <!-- 封面图片 -->
    <div class="card-cover-compact">
      {{ $coverImg := .Params.coverImg }}
      {{ if not $coverImg }}
        {{ $coverImg = "https://img.xxdevops.cn/blog/article_cover/kali-Linux.avif" }}
      {{ end }}

      {{/* 缩略图优化逻辑 */}}
      {{ if .Site.Params.imageThumbnail.enabled }}
        {{ $thumbConfig := .Site.Params.imageThumbnail.articleCard }}
        {{ $width := $thumbConfig.width | default 660 }}
        {{ $height := $thumbConfig.height | default 380 }}
        {{ $quality := $thumbConfig.quality | default 75 }}
        {{ $format := $thumbConfig.format | default "webp" }}

        {{/* 遍历CDN配置,查找匹配的域名 */}}
        {{ range .Site.Params.imageThumbnail.cdnProviders }}
          {{ if in $coverImg .domain }}
            {{/* 移除已有的查询参数 */}}
            {{ $baseUrl := $coverImg }}
            {{ if in $coverImg "?" }}
              {{ $baseUrl = index (split $coverImg "?") 0 }}
            {{ end }}

            {{/* 生成新的缩略图参数 */}}
            {{ $params := .paramFormat }}
            {{ $params = replace $params "{width}" (string $width) }}
            {{ $params = replace $params "{height}" (string $height) }}
            {{ $params = replace $params "{quality}" (string $quality) }}
            {{ $params = replace $params "{format}" $format }}

            {{/* 拼接完整URL */}}
            {{ $coverImg = printf "%s%s" $baseUrl $params }}
          {{ end }}
        {{ end }}
      {{ end }}

      <img data-src="{{ $coverImg }}"
           alt="{{ .Title }}"
           loading="lazy"
           class="lazy-image"
           width="660"
           height="380"
           src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 660 380' preserveAspectRatio='none'%3E%3Crect width='660' height='380' fill='%23f0f0f0'/%3E%3C/svg%3E">
      {{ if or .Params.sticky .Params.featured }}
      <div class="card-badges-compact">
        {{ if .Params.sticky }}
        <span class="badge-compact badge-sticky">置顶</span>
        {{ end }}
        {{ if .Params.featured }}
        <span class="badge-compact badge-featured">推荐</span>
        {{ end }}
      </div>
      {{ end }}
    </div>

    <div class="card-content-compact">
      <!-- 文章标题 -->
      <h2 class="card-title-compact">{{ .Title }}</h2>

      <!-- 文章推荐词/描述（有描述时显示，无描述时置空，限制60字符） -->
      {{- $desc := trim .Description " \t\n\r" -}}
      {{- if and $desc (ne $desc "") -}}
      <div class="card-excerpt-wrapper">
        <p class="card-excerpt-compact" data-full-desc="{{ $desc }}">
          {{ $desc | truncate 60 }}
        </p>
        <div class="excerpt-tooltip"></div>
      </div>
      {{- else -}}
      <p class="card-excerpt-compact"></p>
      {{- end -}}

      <!-- 底部元信息：单行横向布局 -->
      <div class="card-footer-compact">
        <!-- 时间 -->
        <div class="card-meta-item meta-date">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M8 2v4M16 2v4M3 10h18M5 4h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span>{{ .Date.Format "2006-01-02" }}</span>
        </div>

        <!-- 分类（仅在有分类时显示） -->
        {{ if .Params.categories }}
        <div class="card-meta-item meta-category">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          {{ $firstCategory := index .Params.categories 0 }}
          <span class="category-name filter-category" data-category="{{ $firstCategory }}">{{ $firstCategory }}</span>
          {{ if gt (len .Params.categories) 1 }}
          <span class="category-more" data-categories="{{ delimit (after 1 .Params.categories) "," }}">+{{ sub (len .Params.categories) 1 }}</span>
          {{ end }}
        </div>
        {{ end }}

        <!-- 标签（仅在有标签时显示） -->
        {{ if .Params.tags }}
        <div class="card-meta-item meta-tags">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="7" y1="7" x2="7.01" y2="7" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          {{ $firstTag := index .Params.tags 0 }}
          <span class="tag-name filter-tag" data-tag="{{ $firstTag }}">{{ $firstTag }}</span>
          {{ if gt (len .Params.tags) 1 }}
          <span class="tag-more" data-tags="{{ delimit (after 1 .Params.tags) "," }}">+{{ sub (len .Params.tags) 1 }}</span>
          {{ end }}
        </div>
        {{ end }}
      </div>
    </div>
  </a>
</article>
