{{/* ç•™è¨€ç»Ÿè®¡å¡ç‰‡ç»„ä»¶ */}}
<div class="message-stats-container">
  <div class="stats-grid">
    <div class="stat-card stat-total">
      <div class="stat-icon">ğŸ“Š</div>
      <div class="stat-content">
        <div class="stat-value" id="totalComments">
          <span class="loading-spinner">â³</span>
        </div>
        <div class="stat-label">æ€»ç•™è¨€æ•°</div>
      </div>
    </div>

    <div class="stat-card stat-recent">
      <div class="stat-icon">ğŸ”¥</div>
      <div class="stat-content">
        <div class="stat-value" id="recentComments">
          <span class="loading-spinner">â³</span>
        </div>
        <div class="stat-label">æœ¬å‘¨æ–°å¢</div>
      </div>
    </div>

    <div class="stat-card stat-visitors">
      <div class="stat-icon">ğŸ‘¥</div>
      <div class="stat-content">
        <div class="stat-value" id="uniqueVisitors">
          <span class="loading-spinner">â³</span>
        </div>
        <div class="stat-label">å‚ä¸è®¿å®¢</div>
      </div>
    </div>
  </div>

  <div class="stats-activity">
    <div class="activity-label">æ´»è·ƒåº¦æŒ‡æ ‡</div>
    <div class="activity-bar">
      <div class="activity-progress" id="activityProgress" style="width: 0%"></div>
    </div>
    <div class="activity-text" id="activityText">åŠ è½½ä¸­...</div>
  </div>
</div>

<script>
(function() {
  const twikooEnvId = '{{ .Site.Params.comment.envId }}';
  const currentPath = window.location.pathname;

  // è·å–ç•™è¨€ç»Ÿè®¡æ•°æ®
  async function fetchMessageStats() {
    try {
      // ä½¿ç”¨ Twikoo äº‘å‡½æ•° API è·å–è¯„è®ºæ•°æ®
      const response = await fetch(twikooEnvId + '/.netlify/functions/twikoo', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          event: 'GET_COMMENTS',
          url: currentPath,
          includeReply: true
        })
      });

      if (!response.ok) {
        throw new Error('API request failed');
      }

      const data = await response.json();
      const comments = data.data || [];

      // è®¡ç®—ç»Ÿè®¡æ•°æ®
      const totalCount = comments.length;

      // è®¡ç®—æœ€è¿‘7å¤©çš„ç•™è¨€æ•°
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      const recentCount = comments.filter(comment => {
        const commentDate = new Date(comment.created);
        return commentDate >= sevenDaysAgo;
      }).length;

      // è®¡ç®—ç‹¬ç«‹è®¿å®¢æ•°ï¼ˆå»é‡é‚®ç®±ï¼‰
      const uniqueEmails = new Set(comments.map(c => c.mail).filter(Boolean));
      const visitorsCount = uniqueEmails.size;

      // è®¡ç®—æ´»è·ƒåº¦ï¼ˆåŸºäºæœ€è¿‘7å¤©çš„ç•™è¨€å æ¯”ï¼‰
      const activityPercentage = totalCount > 0
        ? Math.round((recentCount / totalCount) * 100)
        : 0;

      // æ›´æ–°UI
      updateStats(totalCount, recentCount, visitorsCount, activityPercentage);

    } catch (error) {
      console.error('è·å–ç•™è¨€ç»Ÿè®¡å¤±è´¥:', error);
      // æ˜¾ç¤ºé™çº§å†…å®¹
      showFallback();
    }
  }

  // æ›´æ–°ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
  function updateStats(total, recent, visitors, activity) {
    // æ•°å­—è®¡æ•°åŠ¨ç”»
    animateNumber('totalComments', 0, total, 1500);
    animateNumber('recentComments', 0, recent, 1200);
    animateNumber('uniqueVisitors', 0, visitors, 1000);

    // æ´»è·ƒåº¦è¿›åº¦æ¡åŠ¨ç”»
    const progressBar = document.getElementById('activityProgress');
    const activityText = document.getElementById('activityText');

    setTimeout(() => {
      progressBar.style.width = activity + '%';

      let level = 'ä½';
      if (activity > 20) level = 'ä¸­';
      if (activity > 50) level = 'é«˜';
      if (activity > 80) level = 'éå¸¸é«˜';

      activityText.textContent = `${level}ï¼ˆæœ€è¿‘7å¤©å æ¯” ${activity}%ï¼‰`;
    }, 500);
  }

  // æ•°å­—è®¡æ•°åŠ¨ç”»
  function animateNumber(elementId, start, end, duration) {
    const element = document.getElementById(elementId);
    const range = end - start;
    const increment = end > start ? 1 : -1;
    const stepTime = Math.abs(Math.floor(duration / range));
    let current = start;

    const timer = setInterval(() => {
      current += increment;
      element.textContent = current + ' æ¡';

      if (current === end) {
        clearInterval(timer);
        element.classList.add('loaded');
      }
    }, stepTime);
  }

  // æ˜¾ç¤ºé™çº§å†…å®¹
  function showFallback() {
    document.getElementById('totalComments').innerHTML = '<span class="fallback">-- æ¡</span>';
    document.getElementById('recentComments').innerHTML = '<span class="fallback">-- æ¡</span>';
    document.getElementById('uniqueVisitors').innerHTML = '<span class="fallback">-- äºº</span>';
    document.getElementById('activityProgress').style.width = '0%';
    document.getElementById('activityText').textContent = 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•';
  }

  // é¡µé¢åŠ è½½åæ‰§è¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchMessageStats);
  } else {
    fetchMessageStats();
  }
})();
</script>
