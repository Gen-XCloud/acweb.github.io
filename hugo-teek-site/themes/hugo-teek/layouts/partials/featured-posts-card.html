{{/* 获取所有推荐文章 */}}
{{ $featuredPosts := where .Site.RegularPages "Params.featured" true }}

{{/* 分组：有权重 vs 无权重 */}}
{{ $withWeight := slice }}
{{ $noWeight := slice }}
{{ range $featuredPosts }}
  {{ if isset .Params "weight" }}
    {{ $withWeight = $withWeight | append . }}
  {{ else }}
    {{ $noWeight = $noWeight | append . }}
  {{ end }}
{{ end }}

{{/* 排序 */}}
{{ $withWeight = sort $withWeight "Params.weight" "asc" }}
{{ $noWeight = sort $noWeight "Date" "desc" }}

{{/* 合并所有推荐文章 */}}
{{ $sortedFeatured := $withWeight | append $noWeight }}
{{ $totalCount := len $sortedFeatured }}
{{ $limit := 5 }}
{{ $interval := 5000 }}
{{ $hasPagination := gt $totalCount $limit }}

<div class="tk-widget-card tk-featured-posts {{ if not $hasPagination }}no-pagination{{ end }}" data-carousel data-auto-play data-interval="{{ $interval }}" data-items-per-page="{{ $limit }}">
  <div class="tk-widget-header">
    <h3 class="tk-widget-title">
      <svg class="tk-widget-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
      </svg>
      精选文章
    </h3>
    <!-- 轮播控制按钮（当文章数超过每页限制时显示） -->
    <div class="tk-carousel-controls">
      <button class="tk-carousel-btn tk-carousel-prev" aria-label="上一页" title="上一页">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
          <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <button class="tk-carousel-btn tk-carousel-next" aria-label="下一页" title="下一页">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
          <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="tk-carousel-container">
    <!-- tk-carousel-wrapper 为轮播容器，JS 会按每页数量显示/隐藏其中的子项 -->
    <div class="tk-carousel-wrapper" style="--items-per-page: {{ $limit }};">
      {{ range $index, $post := $sortedFeatured }}
      <div class="tk-featured-item">
        <a href="{{ $post.RelPermalink }}" class="tk-featured-link">
          {{ $colors := slice "#0891b2" "#8b5cf6" "#ec4899" "#10b981" "#f59e0b" }}
          {{ $colorIndex := mod $index 5 }}
          <div class="tk-featured-icon" style="background: {{ index $colors $colorIndex }};">
            <span class="tk-featured-number">{{ add $index 1 }}</span>
          </div>
          <div class="tk-featured-content">
            <div class="tk-featured-title">
              {{ $post.Title }}
              {{ if $post.Params.sticky }}
              <span class="tk-featured-badge">置顶</span>
              {{ end }}
            </div>
            <div class="tk-featured-date">{{ $post.Date.Format "2006-01-02" }}</div>
          </div>
        </a>
      </div>
      {{ end }}
    </div>
  </div>
</div>
