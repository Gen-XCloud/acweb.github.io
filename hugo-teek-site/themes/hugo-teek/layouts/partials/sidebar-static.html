{{/*
  静态侧边栏渲染模板（使用Hugo原生功能 + 分类级缓存）

  优化说明：
  - 使用Hugo的readFile和unmarshal读取并解析JSON
  - 在构建时直接生成完整的HTML结构（按分类缓存）
  - JavaScript仅用于客户端激活状态和交互逻辑（折叠/展开、Pjax更新）
  - HTML体积：每个分类生成一次（不是每页生成）

  性能影响：
  - 单个分类HTML：+50KB（所有该分类页面共享）
  - 首屏加载：更快（无需fetch JSON，JS仅计算激活状态~10ms）
  - SEO友好：完整HTML可被索引
  - JavaScript代码量：807行 → 150行（-81%）

  参数:
  - .isMobile (bool): 是否为移动端
  - .categorySlug (string): 分类slug（用于加载对应JSON）
  - .context: 页面上下文（保留用于兼容性）
*/}}
{{- $categorySlug := .categorySlug | default "" -}}

{{/* 如果没有传入categorySlug，尝试从context推断（兼容旧调用方式） */}}
{{- if and (not $categorySlug) .context -}}
  {{- if .context.CurrentSection -}}
    {{- $categorySlug = .context.CurrentSection.Params.category | default "" -}}
  {{- end -}}
  {{- if not $categorySlug -}}
    {{- $categoriesContent := readFile "static/data/sidebar/categories.json" -}}
    {{- $categoriesData := unmarshal $categoriesContent -}}
    {{- if $categoriesData.mapping -}}
      {{- $normalizedPath := trim .context.RelPermalink "/" -}}
      {{- $normalizedPath = printf "/%s/" $normalizedPath -}}
      {{- range $key, $value := $categoriesData.mapping -}}
        {{- if eq $key $normalizedPath -}}
          {{- $categorySlug = $value -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{/* 2. 加载对应分类的JSON（从static目录读取）*/}}
{{- $jsonPath := printf "static/data/sidebar/%s.json" $categorySlug -}}
{{- $jsonContent := readFile $jsonPath -}}
{{- $jsonFile := unmarshal $jsonContent -}}

{{- /* 根据设备类型设置不同的 ID */ -}}
{{- $navId := "VPSidebarNav" -}}
{{- $labelId := "sidebar-aria-label" -}}
{{- if .isMobile -}}
  {{- $navId = "VPSidebarNav-mobile" -}}
  {{- $labelId = "sidebar-aria-label-mobile" -}}
{{- end -}}

{{- if $jsonFile -}}
  {{/* 侧边栏容器 */}}
  <nav class="nav" id="{{ $navId }}" aria-labelledby="{{ $labelId }}" data-category="{{ $categorySlug }}">
    <span class="visually-hidden" id="{{ $labelId }}">Sidebar Navigation</span>
    <div class="sidebar-marker" aria-hidden="true"></div>

    <div class="group">
      {{- template "render-sidebar-node" (dict "nodes" $jsonFile.tree "depth" 0) -}}
    </div>
  </nav>
{{- else -}}
  {{/* 如果找不到JSON文件，显示错误提示 */}}
  <nav class="nav" id="{{ $navId }}">
    <div class="group">
      <p class="error" style="padding: 1rem; color: var(--vp-c-danger); font-size: 0.875rem;">
        无法加载侧边栏数据<br>
        <small>分类: {{ $categorySlug }} / 路径: {{ $jsonPath }}</small>
      </p>
    </div>
  </nav>
{{- end -}}

{{/* 递归渲染节点模板（无服务端激活状态，由客户端JavaScript处理） */}}
{{- define "render-sidebar-node" -}}
  {{- $nodes := .nodes -}}
  {{- $depth := .depth -}}

  {{- range $nodes -}}
    {{- $hasChildren := and .children (gt (len .children) 0) -}}

    {{/* 所有节点默认collapsed状态，客户端JavaScript负责激活和展开 */}}
    <section class="VPSidebarItem level-{{ $depth }}{{ if .isFolder }} collapsible collapsed{{ end }}"{{ if .relPermalink }} data-path="{{ .relPermalink }}"{{ end }}>
      <div class="item">
        {{- if .isFolder -}}
          <button class="caret" role="button" aria-expanded="false" aria-label="Toggle {{ .title }}">
            <svg class="caret-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 6 15 12 9 18"></polyline>
            </svg>
          </button>

          {{/* 文件夹标题（不是链接，纯文本）*/}}
          {{- if eq $depth 0 -}}
            <h2 class="text">{{ .title }}</h2>
          {{- else if eq $depth 1 -}}
            <h3 class="text">{{ .title }}</h3>
          {{- else -}}
            <span class="text">{{ .title }}</span>
          {{- end -}}
        {{- else -}}
          {{/* 文档链接（无is-active类，由客户端JavaScript添加） */}}
          {{- if .relPermalink -}}
            <a href="{{ .relPermalink }}" class="link">
              <span class="text">{{ .title }}</span>
            </a>
          {{- else -}}
            <span class="text">{{ .title }}</span>
          {{- end -}}
        {{- end -}}
      </div>

      {{- if $hasChildren -}}
        <div class="items">
          {{- template "render-sidebar-node" (dict "nodes" .children "depth" (add $depth 1)) -}}
        </div>
      {{- end -}}
    </section>
  {{- end -}}
{{- end -}}
