{{/* ä½¿ç”¨ docAnalysis.json ä¸­çš„æ•°æ® */}}
{{ $docAnalysis := .Site.Data.docAnalysis }}
{{/* ç©ºå€¼æ£€æŸ¥ï¼šå¦‚æœ docAnalysis ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼ */}}
{{ $postsCount := 0 }}
{{ $totalWords := 0 }}
{{ $eachFileWords := dict }}
{{ if $docAnalysis }}
  {{ $postsCount = len $docAnalysis.fileList }}
  {{ $totalWords = $docAnalysis.totalFileWords | default 0 }}
  {{ $eachFileWords = $docAnalysis.eachFileWords }}
{{ end }}

{{/* ä» docAnalysis.json ä¸­è®¡ç®—è¿‘ä¸€å‘¨å’Œè¿‘ä¸€æœˆæ–°å¢ */}}
{{ $now := now }}
{{ $weekAgo := $now.AddDate 0 0 -7 }}
{{ $monthAgo := $now.AddDate 0 0 -30 }}
{{ $weekCount := 0 }}
{{ $monthCount := 0 }}

{{/* è°ƒè¯•ä¿¡æ¯ */}}
<!--
ç»Ÿè®¡è°ƒè¯•ä¿¡æ¯ï¼š
å½“å‰æ—¶é—´: {{ $now.Format "2006-01-02 15:04:05" }}
ä¸€å‘¨å‰: {{ $weekAgo.Format "2006-01-02 15:04:05" }}
ä¸€æœˆå‰: {{ $monthAgo.Format "2006-01-02 15:04:05" }}
-->

{{ range $eachFileWords }}
  {{ if .frontmatter.date }}
    {{ $postDate := time .frontmatter.date }}
    {{ if $postDate.After $weekAgo }}
      {{ $weekCount = add $weekCount 1 }}
      <!-- è¿‘ä¸€å‘¨: {{ .frontmatter.title }} - {{ $postDate.Format "2006-01-02" }} -->
    {{ end }}
    {{ if $postDate.After $monthAgo }}
      {{ $monthCount = add $monthCount 1 }}
    {{ end }}
  {{ end }}
{{ end }}

<!-- ç»Ÿè®¡ç»“æœ: è¿‘ä¸€å‘¨ {{ $weekCount }} ç¯‡, è¿‘ä¸€æœˆ {{ $monthCount }} ç¯‡ -->

{{/* ä½¿ç”¨ lastCommitTime ä½œä¸ºæœ€åæ´»åŠ¨æ—¶é—´ */}}
{{ $lastCommitTime := "" }}
{{ if $docAnalysis }}
  {{ $lastCommitTime = $docAnalysis.lastCommitTime | default "" }}
{{ end }}
{{ $latestDate := $now.AddDate -100 0 0 }}
{{ if $lastCommitTime }}
  {{ $latestDate = time $lastCommitTime }}
{{ end }}

{{/* è·å–æ‰€æœ‰æ–‡ç« ç”¨äºè®¡ç®—æ—¶é—´ç»Ÿè®¡ */}}
{{ $allPosts := where .Site.RegularPages "Kind" "page" }}
{{ $allPosts = where $allPosts "Draft" false }}
{{ $latestPost := index (sort $allPosts "Date" "desc") 0 }}

<div class="tk-widget-card tk-site-info-card">
  <div class="tk-widget-header">
    <h3 class="tk-widget-title">
      ğŸ± ç«™ç‚¹ä¿¡æ¯
    </h3>
  </div>

  <div class="tk-site-info-body">
    <div class="info-list">
      <div class="info-item">
        <span class="info-label">æ–‡ç« æ•°ç›®</span>
        <span class="info-value">{{ $postsCount }} ç¯‡</span>
      </div>

      <div class="info-item">
        <span class="info-label">è¿‘ä¸€å‘¨æ–°å¢</span>
        <span class="info-value" id="posts-week">{{ $weekCount }} ç¯‡</span>
      </div>

      <div class="info-item">
        <span class="info-label">è¿‘ä¸€æœˆæ–°å¢</span>
        <span class="info-value" id="posts-month">{{ $monthCount }} ç¯‡</span>
      </div>

      <div class="info-item">
        <span class="info-label">å·²è¿è¡Œæ—¶é—´</span>
        <span class="info-value" id="site-runtime-days">
          {{- if .Site.Params.siteStartDate -}}
            {{- $startDate := time .Site.Params.siteStartDate -}}
            {{- $now := now -}}
            {{- $diffDays := div (sub $now.Unix $startDate.Unix) 86400 -}}
            {{- $years := div $diffDays 365 -}}
            {{- $remainingDays := mod $diffDays 365 -}}
            {{- if gt $years 0 -}}
              {{ $years }} å¹´ {{ $remainingDays }} å¤©
            {{- else -}}
              {{ $diffDays }} å¤©
            {{- end -}}
          {{- else -}}
            æœªé…ç½®
          {{- end -}}
        </span>
      </div>

      <div class="info-item">
        <span class="info-label">æœ¬ç«™æ€»å­—æ•°</span>
        <span class="info-value">
          {{- if ge $totalWords 10000 -}}
            {{ printf "%.1fw" (div (float $totalWords) 10000.0) }} å­—
          {{- else -}}
            {{ $totalWords }} å­—
          {{- end -}}
        </span>
      </div>

      <div class="info-item">
        <span class="info-label">æœ€åæ´»åŠ¨æ—¶é—´</span>
        <span class="info-value" id="last-activity" data-last-commit="{{ $lastCommitTime }}">
          åŠ è½½ä¸­...
        </span>
      </div>

{{ if .Site.Params.analytics.busuanzi.enabled }}
      {{ if .Site.Params.analytics.busuanzi.site_pv }}
      <div class="info-item">
        <span class="info-label">æœ¬ç«™è®¿é—®</span>
        <span class="info-value"><span id="busuanzi_site_pv"></span> æ¬¡</span>
      </div>
      {{ end }}

      {{ if .Site.Params.analytics.busuanzi.site_uv }}
      <div class="info-item">
        <span class="info-label">æœ¬ç«™è®¿å®¢</span>
        <span class="info-value"><span id="busuanzi_site_uv"></span> äºº</span>
      </div>
      {{ end }}

      {{ if .Site.Params.analytics.busuanzi.page_pv }}
      <div class="info-item">
        <span class="info-label">æœ¬é¡µè®¿é—®é‡</span>
        <span class="info-value"><span id="busuanzi_page_pv"></span> æ¬¡</span>
      </div>
      {{ end }}

      <div class="info-item">
        <span class="info-label">æœ¬é¡µè®¿å®¢æ•°</span>
        <span class="info-value"><span id="busuanzi_page_uv"></span> äºº</span>
      </div>
      {{ end }}
    </div>
  </div>
</div>

<!-- Site Info Card JavaScript -->
<script>
  (function() {
    // è¿‘ä¸€å‘¨å’Œè¿‘ä¸€æœˆçš„æ•°æ®å·²åœ¨æœåŠ¡å™¨ç«¯è®¡ç®—ï¼Œæ— éœ€ JavaScript

    // è®¡ç®—è¿è¡Œå¤©æ•°ï¼ˆå®æ—¶æ›´æ–°ï¼‰
    {{ if .Site.Params.siteStartDate }}
    function calculateRuntime() {
      const startDate = new Date('{{ .Site.Params.siteStartDate }}');
      const now = new Date();
      const diffTime = Math.abs(now - startDate);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

      // è®¡ç®—å¹´å’Œå‰©ä½™å¤©æ•°
      const years = Math.floor(diffDays / 365);
      const remainingDays = diffDays % 365;

      let timeText = '';
      if (years > 0) {
        timeText = years + ' å¹´ ' + remainingDays + ' å¤©';
      } else {
        timeText = diffDays + ' å¤©';
      }

      const elem = document.getElementById('site-runtime-days');
      if (elem) {
        elem.textContent = timeText;
      }
    }

    // åˆå§‹åŒ–è¿è¡Œå¤©æ•°
    calculateRuntime();
    // æ¯å¤©æ›´æ–°ä¸€æ¬¡è¿è¡Œå¤©æ•°
    setInterval(calculateRuntime, 86400000);
    {{ end }}

  })();

    // è®¡ç®—æœ€åæ´»åŠ¨æ—¶é—´ï¼ˆåŠ¨æ€æ›´æ–°ï¼‰
    (function updateLastActivity() {
      const elem = document.getElementById('last-activity');
      if (!elem) return;

      const lastCommitTime = elem.getAttribute('data-last-commit');
      if (!lastCommitTime) {
        elem.textContent = 'æœªçŸ¥';
        return;
      }

      function formatTimeAgo() {
        const now = Date.now();
        const past = new Date(lastCommitTime).getTime();
        const diff = now - past;

        const minute = 60 * 1000;
        const hour = 60 * minute;
        const day = 24 * hour;

        if (diff <= minute) {
          return 'åˆšåˆš';
        } else if (diff < hour) {
          return Math.floor(diff / minute) + ' åˆ†é’Ÿå‰';
        } else if (diff < day) {
          return Math.floor(diff / hour) + ' å°æ—¶å‰';
        } else {
          return Math.floor(diff / day) + ' å¤©å‰';
        }
      }

      // åˆå§‹åŒ–æ˜¾ç¤º
      elem.textContent = formatTimeAgo();

      // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
      setInterval(function() {
        elem.textContent = formatTimeAgo();
      }, 60000);
    })();

    // å…œåº•ï¼šç›´æ¥è¯·æ±‚ Busuanzi API å¹¶å¡«å……ï¼ˆä»… classic æ¨¡å¼ä½¿ç”¨ï¼‰
    // EO æ¨¡å¼ä¸‹ï¼Œbusuanzi.eo.js å·²ç»é€šè¿‡ POST è‡ªåŠ¨å¤„ç†ç»Ÿè®¡å’Œæ˜¾ç¤ºï¼Œæ— éœ€å…œåº•
    (function populateBusuanziFallback() {
      try {
        var type = '{{ .Site.Params.analytics.busuanzi.type | default "classic" }}';

        // EO ç‰ˆæœ¬ï¼šå®Œå…¨ç”± busuanzi.eo.js è‡ªåŠ¨å¤„ç†ï¼Œè·³è¿‡å…œåº•é€»è¾‘
        if (type === 'eo') {
          console.log('[Busuanzi EO] è·³è¿‡å…œåº•é€»è¾‘ï¼Œç”± busuanzi.eo.js å¤„ç†');
          return;
        }

        // classic ç‰ˆæœ¬æ‰æ‰§è¡Œå…œåº•é€»è¾‘
        var api = '{{ .Site.Params.analytics.busuanzi.api | default "https://busuanzi.xxdevops.cn/api" }}';
        var prefix = '{{ .Site.Params.analytics.busuanzi.prefix | default "busuanzi" }}';
        if (!api) return;

        fetch(api, { method: 'GET' }).then(function(r){ return r.json(); }).then(function(json){
          var data = json && (json.data || json) || {};
          var keys = ['site_pv','site_uv','page_pv','page_uv','today_pv','today_uv','yesterday_pv','yesterday_uv','month_pv','month_uv'];
          keys.forEach(function(k){
            var el = document.getElementById(prefix + '_' + k) || document.getElementById('busuanzi_' + k) || document.getElementById('busuanzi_value_' + k);
            var v = data[k];
            if (el && (v !== undefined && v !== null && v !== '')) {
              el.textContent = v;
            }
          });
        }).catch(function(){ /* ignore */ });
      } catch (e) { /* ignore */ }
    })();
</script>
